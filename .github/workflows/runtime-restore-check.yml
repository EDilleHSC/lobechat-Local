name: Runtime Restore Check

on:
  workflow_dispatch:

jobs:
  runtime-restore:
    runs-on: windows-latest
    env:
      PORT: 18005
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run runtime restore check
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter runtime_restore_check.js | Select-Object -First 1
          if (-not $test) { Write-Error "runtime_restore_check.js not found"; exit 2 }
          Write-Host "Running runtime restore check: $($test.FullName)"
          node $test.FullName

      - name: Install PM2 (optional)
        run: npm install -g pm2
        shell: pwsh

      - name: Find and start MCP server (background)
        id: start_server
        shell: pwsh
        run: |
          $entry = Get-ChildItem -Path runtime -Recurse -Filter mcp_server.js | Select-Object -First 1
          if (-not $entry) { Write-Error "mcp_server.js not found under runtime/**"; exit 3 }
          Write-Host "Starting server: $($entry.FullName)"
          $p = Start-Process -FilePath node -ArgumentList "`"$($entry.FullName)`"" -PassThru
          $p.Id | Out-File -FilePath server.pid -Encoding ascii
          Write-Host "Server started with PID: $($p.Id)"

      - name: Wait for server health
        shell: pwsh
        run: |
          $ok = $false
          for ($i=0; $i -lt 15; $i++) {
            try {
              $r = Invoke-WebRequest -Uri "http://localhost:$env:PORT/health" -UseBasicParsing -TimeoutSec 3 -ErrorAction Stop
              if ($r.StatusCode -eq 200) { $ok = $true; break }
            } catch {}
            Start-Sleep -Seconds 2
          }
          if (-not $ok) { Write-Error "Server health check failed"; exit 4 }

      - name: Run mailroom smoke test
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter mailroom_smoke.js | Select-Object -First 1
          if (-not $test) { Write-Error "mailroom_smoke.js not found"; exit 5 }
          Write-Host "Running mailroom smoke test: $($test.FullName)"
          node $test.FullName

      - name: Run routing POC smoke test
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter routing_poc_smoke.js | Select-Object -First 1
          if (-not $test) { Write-Error "routing_poc_smoke.js not found"; exit 6 }
          Write-Host "Running routing POC smoke test: $($test.FullName)"
          node $test.FullName

      - name: Run agent receive smoke test
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter agent_receive_smoke.js | Select-Object -First 1
          if (-not $test) { Write-Error "agent_receive_smoke.js not found"; exit 7 }
          Write-Host "Running agent receive smoke test: $($test.FullName)"
          node $test.FullName

      - name: Run PID-file smoke test
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter pidfile_smoke.js | Select-Object -First 1
          if (-not $test) { Write-Error "pidfile_smoke.js not found"; exit 8 }
          Write-Host "Running PID-file smoke test: $($test.FullName)"
          node $test.FullName

      - name: Install AJV (for meta validation)
        shell: pwsh
        run: |
          Write-Host "Installing AJV and formats for metadata validation"
          npm install ajv ajv-formats

      - name: Run metadata validator
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter validate_meta.test.js | Select-Object -First 1
          if (-not $test) { Write-Error "validate_meta.test.js not found"; exit 8 }
          Write-Host "Running metadata validator: $($test.FullName)"
          node $test.FullName

      - name: Validate presenter JSON output
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter validate_presenter_json.js | Select-Object -First 1
          if (-not $test) { Write-Error "validate_presenter_json.js not found"; exit 9 }
          Write-Host "Running presenter JSON validator: $($test.FullName)"
          node $test.FullName

      - name: Guard approved UI from overwrite
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter presenter_no_overwrite.test.js | Select-Object -First 1
          if (-not $test) { Write-Error "presenter_no_overwrite.test.js not found"; exit 10 }
          Write-Host "Running presenter overwrite guard: $($test.FullName)"
          node $test.FullName

      - name: Stop server (cleanup)
        if: always()
        shell: pwsh
        run: |
          if (Test-Path server.pid) {
            $pid = Get-Content server.pid | Select-Object -First 1
            Write-Host "Stopping PID: $pid"
            try { Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue } catch {}
            Remove-Item server.pid -ErrorAction SilentlyContinue
          } else {
            Write-Host "server.pid not found; no cleanup needed"
          }

  presenter-approval-guard:
    name: Presenter Approval Guard
    runs-on: windows-latest
    needs: runtime-restore
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run presenter JSON validator
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter validate_presenter_json.js | Select-Object -First 1
          if (-not $test) { Write-Error "validate_presenter_json.js not found"; exit 1 }
          Write-Host "Running presenter JSON validator: $($test.FullName)"
          node $test.FullName

      - name: Run presenter overwrite guard
        shell: pwsh
        run: |
          $test = Get-ChildItem -Path runtime -Recurse -Filter presenter_no_overwrite.test.js | Select-Object -First 1
          if (-not $test) { Write-Error "presenter_no_overwrite.test.js not found"; exit 1 }
          Write-Host "Running presenter overwrite guard: $($test.FullName)"
          node $test.FullName
