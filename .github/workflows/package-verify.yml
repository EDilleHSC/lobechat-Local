name: Package Verify CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify-packages:
    name: Verify packages and checksums
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: microsoft/setup-powershell@v2
        with:
          powershell-version: '7.4'

      - name: Find and verify archived packages
        shell: pwsh
        run: |
          $NAVI = "$GITHUB_WORKSPACE/NAVI"
          $pkgRoot = Join-Path $NAVI 'archive/packages'
          if (-not (Test-Path $pkgRoot)) { Write-Host "No archived packages found"; exit 0 }
          $pkgs = Get-ChildItem -Path $pkgRoot -Directory
          foreach ($p in $pkgs) {
            Write-Host "Verifying package: $($p.Name)"
            pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/package_finalize.ps1 -PackageName $p.Name -NaviRoot $NAVI -DryRun
          }

      - name: Check for verify reports
        id: check_reports
        shell: pwsh
        run: |
          $glob = 'NAVI/archive/packages/**/verify_report.json'
          $files = Get-ChildItem -Path $glob -ErrorAction SilentlyContinue -File -Force -Recurse
          if ($files) {
            Write-Host "Found $($files.Count) report(s)"
            echo "found=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No verify reports found"
            echo "found=false" >> $env:GITHUB_OUTPUT
          }

      - name: Upload verification reports
        if: ${{ steps.check_reports.outputs.found == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: package-verify-reports-${{ github.run_id }}
          path: 'NAVI/archive/packages/**/verify_report.json'
          retention-days: 30
