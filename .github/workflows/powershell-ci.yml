name: PowerShell Tests & Delivery Verify

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  ps-verify:
    name: PowerShell unit tests & delivery check
    runs-on: windows-latest
    env:
      NAVI_ROOT: ${{ github.workspace }}/NAVI
    steps:
      - uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: microsoft/setup-powershell@v2
        with:
          powershell-version: '7.4'

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser -SkipPublisherCheck

      - name: Run Pester tests
        id: run_pester
        shell: pwsh
        run: |
          if (-not (Test-Path "$env:GITHUB_WORKSPACE/tests/unit")) { Write-Host "No tests folder; skipping"; exit 0 }

          # Find test files by common patterns (*.test.ps1 preferred, fallback to *.Tests.ps1)
          $tests = Get-ChildItem -Path "$env:GITHUB_WORKSPACE/tests/unit" -Recurse -Include '*.test.ps1' -File | Select-Object -ExpandProperty FullName
          if (-not $tests) {
            Write-Host "No '*.test.ps1' found; looking for '*.Tests.ps1'..."
            $tests = Get-ChildItem -Path "$env:GITHUB_WORKSPACE/tests/unit" -Recurse -Include '*.Tests.ps1' -File | Select-Object -ExpandProperty FullName
          }

          if (-not $tests) { Write-Host "No PowerShell unit tests found; skipping"; exit 0 }

          Write-Host "Running Pester on the following files:"; $tests | ForEach-Object { Write-Host " - $_" }

          # Run Pester on all discovered files and emit a report
          Invoke-Pester -Script $tests -EnableExit -OutputFormat Detailed -OutputFile pester-report.xml

      - name: Run delivery status check
        id: run_check
        shell: pwsh
        run: |
          $report = Join-Path $env:GITHUB_WORKSPACE 'delivery_status_pr_check.json'
          pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/check_delivery_status.ps1 -NaviRoot "$env:NAVI_ROOT" -ReportPath $report -FailOnEmpty

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: delivery-ci-artifacts-${{ github.run_id }}
          path: |
            pester-report.xml
            delivery_status_pr_check.json
          retention-days: 30

      - name: Post PR summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`
            const pesterFound = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner, repo: context.repo.repo, run_id: process.env.GITHUB_RUN_ID
            })
            const body = `PowerShell verification completed.\n\n- Pester tests step: ${{ steps.run_pester.outcome }}\n- Delivery check step: ${{ steps.run_check.outcome }}\n\nArtifacts and logs are attached to the run: ${runUrl}`
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body })

  cleanup-smoke:
    name: Cleanup smoke test
    runs-on: windows-latest
    needs: ps-verify
    steps:
      - uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: microsoft/setup-powershell@v2
        with:
          powershell-version: '7.4'

      - name: Run cleanup smoke (non-dry-run) in disposable fixture
        shell: pwsh
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          # create an isolated temp fixture under the runner workspace
          $tmp = Join-Path $env:TEMP ("navi_ci_" + (Get-Date -Format 'yyyyMMdd_HHmmss'))
          New-Item -ItemType Directory -Path (Join-Path $tmp 'NAVI\packages') -Force | Out-Null
          New-Item -ItemType File -Path (Join-Path $tmp 'NAVI\packages\dummy.txt') -Force | Out-Null

          # Execute the cleanup script (pass -Confirm:$false to satisfy the presence of -Confirm)
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/cleanup-reset-runlog.ps1 -NaviRoot "$tmp\NAVI" -Scope tests -Confirm:$false

          # Verify report & backup produced
          $reportDir = Join-Path $tmp 'NAVI\approvals\cleanup_reports'
          if (-not (Test-Path $reportDir)) { Write-Error "cleanup report dir not found"; exit 1 }
          $reports = Get-ChildItem -Path $reportDir -Filter 'cleanup_*.json' -File -ErrorAction SilentlyContinue
          if (($reports | Measure-Object).Count -eq 0) { Write-Error "no cleanup report files found"; exit 2 }

          $archiveDir = Join-Path $tmp 'NAVI\archive'
          if (-not (Test-Path $archiveDir)) { Write-Error "archive folder missing"; exit 3 }

          # Copy reports to workspace for artifact upload
          $dest = Join-Path $env:GITHUB_WORKSPACE 'tmp_cleanup_reports'
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item -Path (Join-Path $reportDir '*') -Destination $dest -Recurse -Force
          Write-Host "Cleanup smoke OK. Reports copied to: $dest"

      - name: Upload cleanup reports
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-reports-${{ github.run_id }}
          path: tmp_cleanup_reports
          retention-days: 7
