name: UI Approval Smoke Test

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  ui-smoke:
    name: UI smoke (Windows matrix)
    runs-on: windows-latest
    strategy:
      matrix:
        shell: [pwsh, bash]
    env:
      MCP_APPROVAL_TOKEN: ${{ secrets.TEST_APPROVAL_TOKEN }}
      ENABLE_TEST_ADMIN: "1"
      MCP_SHUTDOWN_TOKEN: ${{ secrets.TEST_SHUTDOWN_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Start MCP server (background)
        shell: bash
        run: |
          echo "Starting MCP server via pwsh Start-Process with redirected output to $GITHUB_WORKSPACE\\mcp_server.log"
          pwsh -Command "$p = Start-Process -NoNewWindow -FilePath node -ArgumentList 'runtime\\triage_20251216_172245\\mcp_server.js' -RedirectStandardOutput \"$env:GITHUB_WORKSPACE\\mcp_server.log\" -RedirectStandardError \"$env:GITHUB_WORKSPACE\\mcp_server.log\" -PassThru; Start-Sleep -Seconds 1; if (Get-Process -Id $p.Id -ErrorAction SilentlyContinue) { Write-Host ('Process running (PID: {0})' -f $p.Id) } else { Write-Host 'Process not running' }; Write-Host 'Log snippet:'; if (Test-Path \"$env:GITHUB_WORKSPACE\\mcp_server.log\") { Get-Content \"$env:GITHUB_WORKSPACE\\mcp_server.log\" -Tail 20 } else { Write-Host 'Log file not found yet' }"
          # Wait for health endpoint (increased timeout)
          max=60; i=0
          until curl -sS http://localhost:8005/health | grep -q '\"status\"' || [ $i -ge $max ]; do sleep 1; i=$((i+1)); done
          if [ $i -ge $max ]; then echo "Server did not become ready"; echo "---- mcp_server.log (tail) ----"; tail -n 200 "$GITHUB_WORKSPACE/mcp_server.log" || true; exit 1; fi

      - name: Run UI smoke test
        shell: ${{ matrix.shell }}
        run: |
          if [ "${{ matrix.shell }}" = "pwsh" ]; then
            pwsh -File scripts/test_ui_approval_smoke.ps1 -Token $env:MCP_APPROVAL_TOKEN
          else
            bash scripts/test_ui_approval_smoke.sh $MCP_APPROVAL_TOKEN
          fi

      - name: Shutdown MCP server (best-effort)
        shell: bash
        run: |
          echo "Invoking shutdown endpoint..."
          curl -sS -X POST "http://localhost:8005/__mcp_shutdown?token=${{ secrets.TEST_SHUTDOWN_TOKEN }}" || true
          sleep 2
          # Try health once more to ensure it's down (ignore errors)
          if curl -sS http://localhost:8005/health >/dev/null 2>&1; then
            echo "Server still responding after shutdown request" >&2
          else
            echo "Server appears stopped"
          fi

      - name: Upload MCP server log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp_server_log
          path: mcp_server.log
