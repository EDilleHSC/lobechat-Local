<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NAVI Mail Room</title>
  <style>
    body{font-family:Segoe UI,Arial,sans-serif;padding:18px;background:#07102a;color:#fff}
    .card{background:#0f1433;padding:12px;border-radius:8px;margin-bottom:12px}
    .file-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .badge{padding:4px 8px;border-radius:6px}
    .green{background:#0b3f2e;color:#b6f7d2}
    .yellow{background:#5a4f1a;color:#fff3c4}
    .red{background:#3f1b1b;color:#ffd2d2}
    button{padding:6px 10px;border-radius:6px;background:#4ac04a;border:none;color:#04201a;cursor:pointer}
  </style>
</head>
<body>
  <h1>NAVI Mail Room</h1>
  <div style="margin-bottom:12px">
    <label>Approval token: <input id="token" placeholder="X-MCP-APPROVAL-TOKEN"></label>
  </div>
  <div id="list"></div>

  <script>
    // fetch audit and render
    async function fetchAudit(){
      const res = await fetch('/approvals/audit');
      if(!res.ok) return [];
      return await res.json();
    }

    function statusClass(dec){
      if(dec==='Track') return 'green';
      if(dec==='Hold') return 'yellow';
      if(dec==='Escalate') return 'red';
      return '';
    }

    function render(entries){
      // Group by file - pick most recent per file
      const map = new Map();
      for(const e of entries){
        if(!map.has(e.file)) map.set(e.file, e);
      }
      const container = document.getElementById('list');
      container.innerHTML = '';
      for(const [file, info] of map){
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="file-row">
            <div>
              <strong>${file}</strong><div style="font-size:12px;color:#9ea6c0">Last: ${info.decision} by ${info.by} â€¢ ${new Date(info.timestamp).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div class="badge ${statusClass(info.decision)}">${info.decision}</div>
              <button class="open-btn" data-file="${file}">Open</button>
              <button class="preview-btn" data-file="${file}">Preview</button>
              <button class="action-btn" data-file="${file}" data-decision="Track">Track</button>
              <button class="action-btn" data-file="${file}" data-decision="Hold">Hold</button>
              <button class="action-btn" data-file="${file}" data-decision="Escalate">Escalate</button>
            </div>
          </div>
        `;
        container.appendChild(el);
      }
      // Attach handlers
      document.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', onAction));
      document.querySelectorAll('.open-btn').forEach(b => b.addEventListener('click', e => window.open('/' + e.target.dataset.file, '_blank')));
      document.querySelectorAll('.preview-btn').forEach(b => b.addEventListener('click', e => alert('Preview not implemented')));
    }

    async function onAction(e){
      const file = e.target.dataset.file;
      const decision = e.target.dataset.decision;
      // Support test mode: if window.__TEST_PROMPT is set use it, otherwise show prompt
      let notes = '';
      if (typeof window.__TEST_PROMPT !== 'undefined') { notes = window.__TEST_PROMPT || ''; }
      else { notes = prompt(`Notes for ${decision} on ${file}:`) || ''; }
      const token = document.getElementById('token').value.trim();
      try{
        const res = await fetch('/approval', { method:'POST', headers: { 'Content-Type':'application/json', 'X-MCP-APPROVAL-TOKEN': token }, body: JSON.stringify({ approvedBy: 'MailRoom', status: decision, file, notes }) });
        if(res.status === 201){
          await refresh();
          alert('Approval recorded');
        } else {
          const t = await res.text();
          alert('Approval failed: ' + t);
        }
      }catch(err){ alert('Approval request failed: ' + err.message); }
    }

    async function refresh(){
      const entries = await fetchAudit();
      render(entries);
    }

    // Initial
    refresh();
    // Poll for updates occasionally
    setInterval(refresh, 5000);
  </script>
</body>
</html>